<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<configuration xmlns="https://cm5.intertrust.ru/config">
    <domain-object-type name="country" initial-status="Active">
        <fields>
            <string name="name" length="128"/>
            <dateTime name="independence_day"/>
            <long name="population"/>
            <decimal name="square" precision="15" scale="2"/>
            <reference name="capital" type="city"/>
            <reference name="most_famous_city" type="city"/>
            <string name="description" length="1024"/>
        </fields>
        <uniqueKey>
            <field name="name"/>
        </uniqueKey>
        <attachment-types>
            <attachment-type name="country_attachment"/>
        </attachment-types>
    </domain-object-type>

    <domain-object-type name="country_best_friend" initial-status="Active">
        <fields>
            <reference name="country" type="country"/>
            <reference name="best_friend" type="country"/>
            <reference name="description" type="c_best_friend_desc"/>
        </fields>
        <uniqueKey>
            <field name="country"/>
        </uniqueKey>

    </domain-object-type>

    <domain-object-type name="c_best_friend_desc">
        <fields>
            <string name="text" length="100"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="c_best_friend_desc_back">
        <fields>
            <reference name="country_best_friend" type="country_best_friend"/>
            <string name="text" length="100"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="super_country" extends="country" initial-status="Active">
        <fields>
            <string name="additional_name" length="128"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="super_city" extends="city">
        <fields>
            <string name="additional_name" length="128"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="country_city">
        <fields>
            <reference name="country" type="country"/>
            <reference name="city" type="city"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="city">
        <fields>
            <reference name="country" type="country"/>
            <string name="name" length="128"/>
            <long name="population"/>
            <long name="year_of_foundation"/>
            <decimal name="latitude" precision="9" scale="2"/>
            <decimal name="longitude" precision="9" scale="2"/>
            <decimal name="square" precision="9" scale="2"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="federal_unit">
        <fields>
            <reference name="country" type="country"/>
            <string name="name" length="128"/>
            <decimal name="square" precision="9" scale="2"/>
            <reference name="capital" type="city"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="federal_unit_city">
        <fields>
            <reference name="federal_unit" type="federal_unit"/>
            <reference name="city" type="city"/>
        </fields>
    </domain-object-type>



    <form name="country_form" domain-object-type="country" is-default="true" debug = "false">
        <markup>
            <header>
                <table width="800px" height="200px">
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="1"/>
                        </td>
                        <!-- label (Название) -->
                        <td width="100%" h-align="left">
                            <widget id="2"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                </table>
            </header>
            <body display-single-tab="false"> <!-- в теле - только закладки -->
                <tab name="Главная"> <!-- закладка состоит из групп с разметкой -->
                    <single-entry-group> <!-- наследник от TabGroupsConfig -->
                        <tab-group> <!-- вхождение в группу уже может содержать разметку -->
                            <table>
                                <tr>
                                    <td h-align="center" v-align="center">
                                        <widget id="3"/>
                                    </td>
                                    <!-- label (Население) -->
                                    <td h-align="left">
                                        <widget id="4"/>
                                    </td>
                                    <!-- integer-box (Население) -->
                                    <td>
                                        <widget id="5"/>
                                    </td>
                                    <!-- label (Площадь) -->
                                    <td h-align="left">
                                        <widget id="6"/>
                                    </td>
                                    <!-- integer-box (Площадь) -->
                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="7"/>
                                    </td>
                                    <!-- label (Столица) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="8"/>
                                    </td>
                                    <!-- suggest-box (Столица) -->
                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="7a"/>
                                    </td>
                                    <!-- label (Известный город) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="8a"/>
                                    </td>
                                    <!-- suggest-box (Известный город) -->
                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="9"/>
                                    </td>
                                    <!-- label (День независимости) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="10"/>
                                    </td>
                                    <!-- date-box (День независимости) -->
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Описание">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="11"/>
                                    </td>
                                    <!-- label (Описание) -->
                                    <td h-align="left">
                                        <widget id="12"/>
                                    </td>
                                    <!-- text-area (Описание) -->
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Города">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="13"/>
                                    </td>
                                    <!-- label (Города) -->
                                    <td h-align="left">
                                        <widget id="14"/>
                                    </td>
                                    <!-- list-box (Города) -->
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Friends">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td>
                                        <widget id="best_friend_label"/>
                                    </td>
                                    <!-- label (Лучший друг) -->
                                    <td h-align="left">
                                        <widget id="best_friend"/>
                                    </td>
                                    <!-- text-box (Лучший друг (название)) -->
                                </tr>
                                <tr>
                                    <td>
                                        <widget id="best_desc_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="best_friend_desc"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <widget id="best_desc_back_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="best_friend_desc_back"/>
                                    </td>
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Attachments">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td><widget id = "15" width = "760px"/></td>
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
            </body>
        </markup>
        <widget-config>
            <label id="1">
                <field-path/>
                <text>Название:</text>
            </label>
            <text-box id="2">
                <field-path value="name"/>
            </text-box>

            <label id="3">
                <text>Население:</text>
            </label>
            <integer-box id="4">
                <field-path value="population"/>
            </integer-box>

            <label id="5">
                <text>Площадь:</text>
            </label>
            <label id="6">
                <field-path value="square"/>
            </label>

            <label id="7">
                <text>Столица:</text>
            </label>
            <list-box id="8a">
                <field-path value="capital"/>
                <!--а для области столицы: capital . federal_unit_city^city . federal_unit . name &ndash;&gt;  -->
                <pattern value="{name} ({population} чел.)"/>
            </list-box>
            <!--
            <label id="7a">
                <text>Известный город:</text>
            </label>       -->
           <!-- <suggest-box id="8a">
                <field-path value="most_famous_city"/>
                &lt;!&ndash; а для области столицы: capital . federal_unit_city^city . federal_unit . name &ndash;&gt;

                <pattern value="{name} ({population} чел.)"/>

                <collection-ref name="Cities"/>

                &lt;!&ndash; название фильтра, использующегося при получении описания уже выбранных значений &ndash;&gt;
                <selection-filter name="idsIncluded"/>

                &lt;!&ndash; название фильтра, отсекающего, уже выбранные значения (для того, чтобы они не показывались  списке &ndash;&gt;
                <selection-exclude-filter name="idsExcluded"/>

                &lt;!&ndash; паттерн отображения значений выпадающего списка &ndash;&gt;
                <drop-down-pattern value="{first_name} {last_name} {position}"/>

                &lt;!&ndash; паттерн отображения уже выбранных значений &ndash;&gt;
                <selection-pattern value="{first_name} {last_name}"/>

                &lt;!&ndash; название фильтра по тексту, введённому пользователем &ndash;&gt;
                <input-text-filter name="byText"/>

                &lt;!&ndash; количество элементов, показываемых на одной странице выпадающего списка &ndash;&gt;
                <page-size>30</page-size>
            </suggest-box>-->

            <!--<label id="best_friend_label">
                <text>Лучший друг (назв. страны):</text>
            </label>
            <text-box id="best_friend">
                <field-path value="country_best_friend^country.best_friend.name"/>
            </text-box>

            <label id="best_desc_label">
                <text>Description:</text>
            </label>
            <text-box id="best_friend_desc">
                <field-path value="country_best_friend^country.description.text"/>
            </text-box>

            <label id="best_desc_back_label">
                <text>Description (Back):</text>
            </label>
            <text-box id="best_friend_desc_back">
                <field-path value="country_best_friend^country.c_best_friend_desc_back^country_best_friend.text"/>
            </text-box>-->

            <label id="best_friend_label">
                <text>Название столицы:</text>
            </label>
            <text-box id="best_friend">
                <field-path value="capital.name"/>
            </text-box>

            <label id="best_desc_label">
                <text>Города (N:M)</text>
            </label>
            <list-box id="best_friend_desc">
                <field-path value="country_city^country.city"/>
                <pattern value="{name} ({population} чел.)"/>
            </list-box>

            <label id="9">
                <text>День независимости:</text>
            </label>
            <date-box id="10">
                <field-path value="independence_day"/>
            </date-box>

            <label id="11">
                <text>Описание:</text>
            </label>
            <text-area id="12">
                <field-path value="description"/>
            </text-area>

            <label id="13">
                <text>Города:</text>
            </label>
            <list-box id="14"> <!-- в поле City.country надо сохранить Id текущей страны??? -->
                <field-path value="city^country"/>
                <!-- редактирует названи-->
                <pattern value="{name} ({population} чел.)"/>
            </list-box>
            <attachment-box id="15">
                <field-path value = "country_attachment^country"/>

                <!-- Впоследствии будет добавлена поддержка, тогда не обязателен станет field-path. Сейчас добавлять не надо. -->
                <attachment-type-ref name="country_attachment"/>
                <scanner enabled="true"/>
            </attachment-box>
        </widget-config>
    </form>
    <form name="city_form" domain-object-type="city" is-default="true">
        <markup>
            <header>
                <table width="500px" height="200px">
                    <tr>
                        <td width="100pxx" h-align="righ">
                            <widget id="1"/>
                        </td>
                        <!-- label (Название) -->
                        <td width="100%" h-align="left">
                            <widget id="2"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                </table>
            </header>
            <body display-single-tab="false"> <!-- в теле - только закладки -->
                <tab name="Главная"> <!-- закладка состоит из групп с разметкой -->
                    <single-entry-group> <!-- наследник от TabGroupsConfig -->
                        <tab-group> <!-- вхождение в группу уже может содержать разметку -->
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="3"/>
                                    </td>
                                    <!-- label (Население) -->
                                    <td h-align="left">
                                        <widget id="4"/>
                                    </td>
                                    <!-- integer-box (Население) -->

                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="5"/>
                                    </td>
                                    <!-- label (Год основания) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="6"/>
                                    </td>
                                    <!-- date-box (Год основания) -->
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Дополнительно">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="7"/>
                                    </td>
                                    <!-- label (Площадь) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="8"/>
                                    </td>
                                    <!-- decimal-box (Площадь) -->
                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="9"/>
                                    </td>
                                    <!-- label (Широта) -->
                                    <td h-align="left">
                                        <widget id="10"/>
                                    </td>
                                    <!-- decimal-box  (Широта) -->

                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="11"/>
                                    </td>
                                    <!-- label (Долгота) -->
                                    <td colspan="3" h-align="left">
                                        <widget id="12"/>
                                    </td>
                                    <!-- decimal-box  (Долгота) -->
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
            </body>
        </markup>
        <widget-config>
            <label id="1">
                <field-path/>
                <text>Название:</text>
            </label>
            <text-box id="2">
                <field-path value="name"/>
            </text-box>

            <label id="3">
                <text>Население:</text>
            </label>
            <integer-box id="4">
                <field-path value="population"/>
            </integer-box>

            <label id="5">
                <text>Год основания:</text>
            </label>
            <integer-box id="6">
                <field-path value="year_of_foundation"/>
            </integer-box>

            <label id="7">
                <text>Площадь:</text>
            </label>
            <decimal-box id="8">
                <field-path value="square"/>
            </decimal-box>

            <label id="9">
                <text>Широта:</text>
            </label>
            <decimal-box id="10">
                <field-path value="latitude"/>
            </decimal-box>

            <label id="11">
                <text>Долгота:</text>
            </label>
            <decimal-box id="12">
                <field-path value="longitude"/>
            </decimal-box>

        </widget-config>
    </form>
    <collection name="Countries" idField="id">
        <!--todo поддержка конвертации значений, например, в картинки -->
        <prototype>
            <![CDATA[
                select
                 co.id, co.name, co.independence_day, co.population, co.description, co.capital
                from
                    country co
                     ::from-clause
                where
                    1=1 ::where-clause
            ]]>
        </prototype>
        <!-- если запрос-счётчик отсутствует, то в select подставляется count(*) вместо названий колонок -->
        <counting-prototype>
            select count(*) from country co ::from-clause WHERE 1=1 ::where-clause
        </counting-prototype>
    </collection>
    <collection-view name="countries_default_view" collection="Countries" is-default="true">
        <display>
            <column field="id" name="id" type="integer" sortable="false"/>
            <column field="name" name="Название" editable="false" type="string" sortable="true"/>
            <column field="independence_day" name="День Независимости" type="datetime" editable="false"
                    sortable="true"/>
            <column field="population" name="Популяция" type="string" editable="false" sortable="true"/>
            <column field="description" name="Описание" type="string" editable="false" sortable="true"/>
        </display>
    </collection-view>

    <collection name="Cities" idField="id">
        <prototype>
            <![CDATA[
                select
                 ci.id,   ci.name, ci.population, ci.year_of_foundation, ci.latitude, ci.longitude, ci.square
                from
                    city ci
                     ::from-clause
                where
                    1=1 ::where-clause
            ]]>
        </prototype>
        <!-- если запрос-счётчик отсутствует, то в select подставляется count(*) вместо названий колонок -->
        <counting-prototype>
            select count(*) from city ci ::from-clause WHERE 1=1 ::where-clause
        </counting-prototype>

        <filter name="idsIncluded">
            <criteria placeholder="where-clause">
                <![CDATA[
                    ci.id in ({0})
                ]]>
            </criteria>
        </filter>
        <filter name="idsExcluded">
            <criteria placeholder="where-clause">
                <![CDATA[
                    ci.id not in ({0})
                ]]>
            </criteria>
        </filter>
        <filter name="byText">
            <criteria placeholder="where-clause">
                <![CDATA[
                    ci.name like {0}
                ]]>
            </criteria>
        </filter>

    </collection>
    <collection-view name="cities_default_view" collection="Cities" is-default="true">
        <display>
            <column field="id" name="id" type="integer" sortable="false"/>
            <column field="name" name="Название" editable="false" type="string" sortable="true"/>
            <column field="population" name="Популяция" type="string" editable="false" sortable="true"/>
            <column field="year_of_foundation" name="Год основания " type="integer" editable="false" sortable="true"/>
            <column field="latitude" name="Широта" type="string" editable="false" sortable="true"/>
            <column field="longitude" name="Долгота" type="string" editable="false" sortable="true"/>
            <column field="square" name="Площадь" type="string" editable="false" sortable="true"/>
        </display>
    </collection-view>

    <form-mappings name="country_mappings">
        <form-mapping domain-object-type="country" form="country_form">
            <users>
                <user uid="admin"/>
            </users>
            <roles>
                <role name="Minister"/>
            </roles>
        </form-mapping>
    </form-mappings>

    <form-mappings name="city_mappings">
        <form-mapping domain-object-type="city" form="city_form">
            <users>
                <user uid="admin"/>
            </users>
            <roles>
                <role name="Minister"/>
            </roles>
        </form-mapping>
    </form-mappings>
</configuration>
