<?xml version="1.1" encoding="UTF-8" standalone="yes"?>
<configuration xmlns="https://cm5.intertrust.ru/config">

    <domain-object-type name="Attachment" template="true">
        <fields>
            <string name="Name" length="128"/>
            <string name="Path" length="128"/>
            <string name="MimeType" length="128"/>
            <string name="Description" length="128"/>
            <long name="ContentLength"/>
        </fields>
        <indices>
            <index>
                <field name="Path"/>
            </index>
        </indices>
    </domain-object-type>

    <domain-object-type name="Status" db-id="31">
        <fields>
            <string name="Name" length="128" not-null="true"/>
            <string name="Description" length="128"/>
        </fields>
        <uniqueKey>
            <field name="Name"/>
        </uniqueKey>
    </domain-object-type>

    <!--Доменные объекты для протоколирования системных событий (Login/Logout/Download Attachment/DO Access) -->
    <field-group name="user_event_info">
        <reference name="person" type="Person" />
        <string name="client_ip_address" length="20" />
        <string name="user_id" length="128" />        
    </field-group>

    <!-- Протоколирование входа/выхода пользователя -->
    <domain-object-type name="user_event_log" audit-log="false">
        <fields>
            <string name="event_type" length="64" not-null="true" />
            <!--Поля для субъекта Персоны -->
            <include-group name="user_event_info" />
            <!-- Поле date необходимо, т.к. дата в created_date может не совпадать с датой протоколирования в случае асинхронного 
                логирования. -->
            <date-time name="date" not-null="true" />
            <!-- Успешный/неуспешный логин -->
            <boolean name="success" />
        </fields>
    </domain-object-type>

    <!--Протоколирование доступа к объектам и вложениям -->
    <domain-object-type name="object_access_log" audit-log="false">
        <fields>
            <string name="event_type" length="64" not-null="true" />
            <!--Поля для субъекта Персоны -->
            <include-group name="user_event_info" />

            <!-- Поле для системного процесса. Возможно это поле не нужно. Если person пустое, значит, выполняется от имени 
                системы. -->
            <string name="process_name" length="128" />
            <!-- Ссылка на бизнес-ДО или на вложение. Отличить вложение можно по типу события DOWNLOAD_ATTACHMENT -->
            <reference name="object" type="*" not-null="true" />
            <string name="access_type" length="1" /> <!-- R|W -->

            <!-- Поле date необходимо, т.к. дата в created_date может не совпадать с датой протоколирования в случае асинхронного 
                логирования. -->
            <date-time name="date" not-null="true" />
            <!-- Содержит результат предоставления доступа (в случае AccessException и ObjectNotFoundException записывается 
                false) и результат получения вложения (в случае FileNotFoundException записывается false) -->
            <boolean name="success" />
        </fields>
    </domain-object-type>

    <domain-object-type name="bu_user_settings" initial-status="Active">
        <fields>
            <reference name="person" type="person"/>
            <string name="theme" length="128"/>
            <long name="splitter_orientation"/>
            <long name="splitter_position"/>
            <long name="custom_splitter_position"/>
            <string name="nav_link" length="2048"/>
            <boolean name="nav_panel_level2_pinned" not-null="false"/>
            <string name="application" length="128"/>
        </fields>
        <indices>
            <index>
                <field name="person"/>
                <field name="application"/>
            </index>
        </indices>
    </domain-object-type>

    <!-- История состояния иерархического плагина -->
    <domain-object-type name="bu_user_hip_settings" initial-status="Active">
        <fields>
            <reference name="person" type="person"/>
            <text name="plugin_state_json"/>
            <string name="plugin_id" length="128"/>
        </fields>
        <indices>
            <index>
                <field name="person"/>
                <field name="plugin_id"/>
            </index>
        </indices>
    </domain-object-type>

    <domain-object-type name="bu_nav_link_collection" initial-status="Active">
        <fields>
            <reference name="person" type="person"/>
            <string name="link" length="128"/>
            <string name="collection_view_name" length="128"/>
            <text name="collection_view"/>
            <text name="collection_viewer"/>
            <long name="collection_count"/>
            <string name="application" length="128"/>
        </fields>
        <indices>
            <index>
                <field name="person"/>
                <field name="application"/>
                <field name="link"/>
            </index>
        </indices>
    </domain-object-type>
    <domain-object-type name="migration_log">
        <fields>
            <long name="sequence_number"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="plugin_status" initial-status="Sleep">
        <fields>
            <string name="plugin_id" length="256" not-null="true"/>
            <date-time name="last_start"/>
            <date-time name="last_finish"/>
        </fields>
        <uniqueKey>
            <field name="plugin_id"/>
        </uniqueKey>
        <attachment-types>
            <attachment-type name="execution_log"/>
        </attachment-types>
    </domain-object-type>
    
    <collection name="last_migration_log" idField="id">
        <prototype>
            <![CDATA[
                    select * from migration_log where sequence_number = (select max(sequence_number) from migration_log)
            ]]>
        </prototype>
    </collection>
    <collection name="bu_user_settings_collection" idField="id">
        <prototype>
            <![CDATA[
                    select bus.id, bus.theme, bus.splitter_orientation, bus.splitter_position, bus.nav_link, bus.application
                    from bu_user_settings bus
                    inner join Person p on (p.id = bus.person)
                    ::from-clause
                    where 1=1 ::where-clause
            ]]>
        </prototype>
        <counting-prototype>
            select count(*) from bu_user_settings bus bus ::from-clause WHERE 1=1 ::where-clause
        </counting-prototype>
        <filter name="byPerson">
            <criteria placeholder="where-clause">
                <![CDATA[
                    p.login = {0}
                ]]>
            </criteria>
        </filter>
    </collection>

    <collection name="bu_user_hip_settings_collection" idField="id">
        <prototype>
            <![CDATA[
                    select
                    hs.id,
                    hs.plugin_state_json,
                    hs.plugin_id
                    from bu_user_hip_settings hs
                    inner join Person p on (p.id = hs.person)
                    ::from-clause
                    where 1=1 ::where-clause
            ]]>
        </prototype>
        <counting-prototype>
            select count(*) from bu_user_hip_settings hs ::from-clause WHERE 1=1 ::where-clause
        </counting-prototype>

        <filter name="byPerson">
            <criteria placeholder="where-clause">
                <![CDATA[
                    p.login = {0}
                ]]>
            </criteria>
        </filter>

        <filter name="byPid">
            <criteria placeholder="where-clause">
                <![CDATA[
                    upper(hs.plugin_id) like upper({1})
                ]]>
            </criteria>
        </filter>
    </collection>

    <collection name="bu_nav_link_collections" idField="id">
        <prototype>
            <![CDATA[
                select
                    blc.id, blc.collection_view, blc.collection_viewer, blc.application
                from
                    bu_nav_link_collection blc
                    inner join Person p on (blc.person = p.id)
                     ::from-clause
                where
                    1=1 ::where-clause
            ]]>
        </prototype>
        <!-- если запрос-счётчик отсутствует, то в select подставляется count(*) вместо названий колонок -->
        <counting-prototype>
            select count(*) from bu_nav_link_collection blc ::from-clause WHERE 1=1 ::where-clause
        </counting-prototype>

        <filter name="byLink">
            <criteria placeholder="where-clause">
                <![CDATA[
                    blc.link = {0}
                ]]>
            </criteria>
        </filter>
        <filter name="byCollectionViewName">
            <criteria placeholder="where-clause">
                <![CDATA[
                    blc.collection_view_name = {0}
                ]]>
            </criteria>
        </filter>
        <filter name="byApplicationName">
            <criteria placeholder="where-clause">
                <![CDATA[
                    blc.application = {0}
                ]]>
            </criteria>
        </filter>
        <filter name="byPerson">
            <criteria placeholder="where-clause">
                <![CDATA[
                    p.login = {0}
                ]]>
            </criteria>
        </filter>
    </collection>
</configuration>