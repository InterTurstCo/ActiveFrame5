<?xml version="1.0" encoding="UTF-8"?>
<configuration xmlns="https://cm5.intertrust.ru/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <!-- Статические группы пользователей - мы вынуждены объявлять их здесь, 
        т.к. они используются в матрицах доступа -->
    <static-group name="Администраторы" />

    <!-- Динамические группы пользователей - вычисляются системой -->
    <dynamic-group name="Все пользователи">
        <!-- Бесконтекстная - существует в единственном экземпляре -->
        <members>
            <!-- Отслеживаем сохранение/удаление объектов типа "Person" в 
                статусе "active" и включаем их в группу -->
            <track-domain-objects type="Person"
                status="active" />
        </members>
    </dynamic-group>

    <dynamic-group name="Пользователь">
        <!-- По одной группе на каждый объект "Person" (пользователь) в системе -->
        <context>
            <domain-object type="Person" />
        </context>
        <members>
            <!-- Отслеживаем сохранение/удаление объектов типа "Person" в 
                статусе "active" и включаем их в соответствующую группу, т.е. где контекст 
                = объекту -->
            <track-domain-objects type="Person"
                status="active" />
        </members>
    </dynamic-group>

    <dynamic-group name="Пользователь и его заместители">
        <!-- По одной группе на каждый объект "Person" (пользователь) в системе -->
        <context>
            <domain-object type="Person" />
        </context>
        <members>
            <!-- Отслеживаем сохранение/удаление объектов типа "Delegation" 
                в статусе "active" -->
            <track-domain-objects type="Delegation"
                status="active">
                <!-- Указываем, какую именно группу (с каким контекстом) 
                    менять - берём пользователя из поля "person" -->
                <bind-context>
                    <doel>person</doel>
                </bind-context>
                <!-- Указываем, как получить пользователя, который войдёт 
                    в группу - берём его из поля "delegate" -->
                <get-person>
                    <doel>delegate</doel>
                </get-person>
            </track-domain-objects>
        </members>
    </dynamic-group>

    <dynamic-group name="Сотрудники подразделения">
        <!-- По одной группе на каждый объект "Department" (подразделение) 
            в системе -->
        <context>
            <domain-object type="Department" />
        </context>
        <members>
            <!-- Отслеживаем сохранение/удаление объектов типа "Person" в 
                статусе "active" -->
            <track-domain-objects type="Employee"
                status="active">
                <!-- Контекст для включения в группу берём из поля "Department" -->
                <bind-context>
                    <doel>Department</doel>
                </bind-context>
            </track-domain-objects>
        </members>
    </dynamic-group>

    <dynamic-group name="Сотдруники подразделения пользователя">
        <!-- По одной группе на каждый объект "Employee" (сотрудник) в системе -->
        <context>
            <domain-object type="Employee" />
        </context>
    </dynamic-group>

    <!-- <dynamic-group name="Исполнители Поручений">
        По одной группе на каждый объект "Outgoing_Document" (документ) в системе
        <context>
            <domain-object type="Outgoing_Document" />
        </context>
        <members>
            Отслеживаем сохранение/удаление объектов типа "Подпись" в статусе "active"
            <track-domain-objects type="Execution" status="active">
                <bind-context>
                    <doel>parent.parent</doel>
                </bind-context>
                <get-person>
                    <doel>executor</doel>
                </get-person>
            </track-domain-objects>

            <track-domain-objects type="Commission">
                <bind-context>
                    <doel>parent</doel>
                </bind-context>
                <get-person>
                    <doel>Execution^parent.executor</doel>
                </get-person>
            </track-domain-objects>
        </members>
    </dynamic-group>
-->    

    <!-- Forward Link used from Doc1 to Doc 3 -->
    <!--
    Doc1      ->        Doc2         ->   Doc3
    linkToDoc2          linkToDoc3        fieldDoc3
    -->
 <!--    <dynamic-group name="Rule on Field Doc3 ">
        <context>
            <domain-object type="Doc1" />
        </context>
        <members>            
            <track-domain-objects type="Doc3" status="active">
                <bind-context>
                    <doel>Doc2^linkToDoc3.Doc1^linkToDoc2</doel>
                </bind-context>
                <get-person>
                    <doel>fieldDoc3</doel>
                </get-person>
            </track-domain-objects>

            <track-domain-objects type="Doc2">
                <bind-context>
                    <doel>Doc1^linkToDoc2</doel>
                </bind-context>
                <get-person>
                    <doel>linkToDoc3.fieldDoc3</doel>
                </get-person>
            </track-domain-objects>
        </members>
    </dynamic-group> -->

    <!-- Back link  from Doc1 to Doc3-->
    <!--
    Doc1      ->        Doc2         ->   Doc3
    linkToDoc2          linkToDoc1        linkToDoc2
                                          fieldDoc3
    -->
    <!-- <dynamic-group name="Rule on Field Doc3 ">
        <context>
            <domain-object type="Doc1" />
        </context>
        <members>            
            <track-domain-objects type="Doc3" status="active">
                <bind-context>
                    <doel>linkToDoc2.linkToDoc1</doel>
                </bind-context>
                <get-person>
                    <doel>fieldDoc3</doel>
                </get-person>
            </track-domain-objects>

            <track-domain-objects type="Doc2">
                <bind-context>
                    <doel>linkToDoc1</doel>
                </bind-context>
                <get-person>
                    <doel>Doc3^linkDoc2.fieldDoc3</doel>
                </get-person>
            </track-domain-objects>
        </members>
    </dynamic-group> -->

    <!-- Контекстные роли -->
    <context-role name="Автор документа">
        <context>
            <domain-object type="Outgoing_Document"  />
        </context>
        <groups>
            <track-domain-objects>
                <get-group name="Пользователь и его заместители">
                    <doel>Author</doel>
                </get-group>
            </track-domain-objects>
        </groups>
    </context-role>

    <!-- Матрицы доступа -->
    <access-matrix type="Outgoing_Document">
        <status name="Draft">
            <read>
                <permit-role name="Автор документа"></permit-role>
                <permit-group name="Пользователь и его заместители"></permit-group>
            </read>
            <write>
                <permit-role name="Автор документа"></permit-role>
            </write>
            <delete>
                <permit-role name="Автор документа"></permit-role>
            </delete>            
            <create-child type="Employee">
                <permit-role name="Автор документа"></permit-role>
            </create-child>
            <execute-action name="action1">
                <permit-role name="Автор документа"></permit-role>
            </execute-action>            
        </status>
    </access-matrix>
</configuration>


