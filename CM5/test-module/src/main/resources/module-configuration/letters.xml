<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<configuration xmlns="https://cm5.intertrust.ru/config">
    <domain-object-type name="letter" initial-status="Active">
        <fields>
            <string name="subject" length="128"/>
            <string name="password" length="128" encrypted="true"/>
            <date-time name="actual_start_period"/>
            <date-time name="actual_end_period"/>
            <long name="priority"/>
        </fields>
    </domain-object-type>
    <domain-object-type name="letter_creator" initial-status="Active">
        <fields>
            <reference name="letter" type="letter"/>
            <reference name="employee" type="Employee"/>
        </fields>
    </domain-object-type>
    <domain-object-type name="letter_addressee">
        <fields>
            <reference name="letter" type="letter"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="organization_addressee" extends="letter_addressee">
        <fields>
            <reference name="organization" type="Organization"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="department_addressee" extends="letter_addressee">
        <fields>
            <reference name="department" type="Department"/>
        </fields>
    </domain-object-type>

    <domain-object-type name="employee_addressee" extends="letter_addressee">
        <fields>
            <reference name="employee" type="Employee"/>
        </fields>
    </domain-object-type>

    <form name="org_middle_form" domain-object-type="org_middle" is-default="true">
        <markup>
            <header>
                <table>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="name_label"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="name"/>
                        </td>
                    </tr>
                </table>
            </header>
            <body display-single-tab="false">
                <tab name="Главная">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="org_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="org"/>
                                    </td>
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>

            </body>
        </markup>
        <widget-config>
            <label id="name_label">
                <field-path/>
                <text>Имя:</text>
            </label>
            <text-box id="name">
                <field-path value="name"/>
            </text-box>

            <label id="org_label">
                <text>Организация:</text>
            </label>

            <!-- <list-box id="addressees">
                 <field-path value="organization_addressee^letter.organization, department_addressee^letter.department, employee_addressee^letter.employee"/>
                 <pattern value="{Name}"/>
             </list-box>-->
            <suggest-box id="org">
                <field-path value="organization"/>

                <collection-ref name="Organizations"/>

                <!-- паттерн отображения значений выпадающего списка -->
                <drop-down-pattern value="{name}"/>

                <!-- паттерн отображения уже выбранных значений -->
                <selection-pattern value="{name}"/>

                <!-- название фильтра по тексту, введённому пользователем -->
                <input-text-filter name="byText"/>

                <!-- количество элементов, показываемых на одной странице выпадающего списка -->
                <page-size>30</page-size>

                <!--name может принимать 2 значения inline (стиль Студии Лебедева) и table (текущая реализация).
                    Если тэг отсутствует, то используется "inline"-вариант. -->
                <selection-style name="inline"/>
                <single-choice value="true"/>
                <clear-all-button text="Очистить"/>
                <default-sort-criteria column-field="name" order="asc"/>
            </suggest-box>
        </widget-config>
    </form>


    <form name="letter_form" domain-object-type="letter" is-default="true">
        <markup>
            <header>
                <table>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="subject_label"/>
                        </td>
                        <td width="200px" h-align="left">
                            <widget id="subject"/>
                        </td>
                        <td width="100px" h-align="right">
                            <widget id="password_label"/>
                        </td>
                        <td width="100px" h-align="left">
                            <widget id="password"/>
                        </td>
                    </tr>
                </table>
            </header>
            <body display-single-tab="false">
                <tab name="Главная">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="addressees_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="addressees_label"/>
                                        <!--<widget id="addressees"/>-->
                                    </td>
                                </tr>
                                <tr>
                                    <td h-align="left">
                                        <widget id="actual_start_period_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="actual_start_period"/>
                                    </td>
                                    <td h-align="right">
                                        <widget id="actual_end_period_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="actual_end_period"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="letter_creators_label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="letter_creators"/>
                                    </td>
                                    <td>
                                        <widget id="letter_priority_label"/>
                                    </td>
                                    <td>
                                        <widget id="letter_priority"/>
                                    </td>
                                </tr>

                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
                <tab name="Иерархический браузер">
                    <single-entry-group>
                        <tab-group>
                            <table>
                                <tr>
                                    <td>
                                        <widget id="2c"/>
                                    </td>
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
            </body>
        </markup>
        <widget-config>
            <label id="letter_creators_label">
                <field-path/>
                <text>Создатели письма:</text>
            </label>
            <suggest-box id="letter_creators">
                <field-path value="letter_creator^letter.employee"/>
                <collection-ref name="Employees"/>
                <drop-down-pattern value="{name}"/>
                <selection-pattern value="{name}"/>
                <input-text-filter name="byFirstLetter"/>
                <page-size>20</page-size>
                <single-choice value="false"/>
                <clear-all-button text="Очистить"/>
            </suggest-box>
            <label id="subject_label">
                <field-path/>
                <text>Тема:</text>
            </label>
            <text-box id="subject">
                <field-path value="subject"/>
            </text-box>
            <label id="password_label">
                <field-path/>
                <text>Пароль:</text>
            </label>
            <text-box id="password">
                <field-path value="password"/>
            </text-box>

            <label id="addressees_label">
                <text>Адресаты:</text>
            </label>

            <label id="letter_priority_label">
                <field-path/>
                <text>Приоритет:</text>
            </label>
            <enumeration-box id="letter_priority">
                <field-path value="priority"/>
                <mapping>
                    <map value="1" display-text="низкий"/>
                    <map value="2" display-text="обычный"/>
                    <map value="3" display-text="срочный"/>
                </mapping>
            </enumeration-box>

            <hierarchy-browser id="2c">
                <field-path
                        value="organization_addressee^letter.organization, department_addressee^letter.department, employee_addressee^letter.employee"/>

                <!-- Определение списка/таблицы, выпадающего при раскрытии узла -->
                <!-- Уже выбранные элементы показываются помеченными галочками -->
                <!-- collection - название коллекции для отображения списка значений узла -->

                <node-collection-def collection="organizations" domain-object-type="organization"
                                     title="Организацию">
                    <root-node-link title="Организации"/>
                    <!-- название фильтра по тексту, введённому пользователем -->
                    <input-text-filter name="byName"/>
                    <!-- паттерн отображения уже выбранных значений -->
                    <selection-pattern value="{name}"/>
                    <default-sort-criteria column-field="name" order="asc"/>
                    <selection-filters row-limit="2">

                    </selection-filters>
                    <selection-sort-criteria>
                        <sort-criterion field="name" order="asc"/>
                    </selection-sort-criteria>
                    <!--<selection-filters row-limit="1"></selection-filters>-->
                    <node-collection-def collection="departments" parent-filter="byOrganization"
                                         domain-object-type="department" title="Департамент">
                        <!-- название фильтра по тексту, введённому пользователем -->
                        <fill-parent-on-add field-to-fill="organization"/>

                        <input-text-filter name="byName"/>
                        <!-- паттерн отображения уже выбранных значений -->
                        <selection-pattern value="{name}"/>
                        <!-- путь к узлу верхнего уровня (относительно пути этого узла) от узла данного уровня -->
                        <node-collection-def collection="employees" parent-filter="byDepartment"
                                             domain-object-type="employee" title="Сотрудника">
                            <!-- название фильтра по тексту, введённому пользователем -->
                            <fill-parent-on-add field-to-fill="department"/>
                            <input-text-filter name="byName"/>
                            <!-- паттерн отображения уже выбранных значений -->
                            <selection-pattern value="{name} {position}"/>
                            <!-- путь к узлу верхнего уровня (относительно пути этого узла) от узла данного уровня -->

                        </node-collection-def>
                    </node-collection-def>
                    <node-collection-def collection="employeesWithoutDepartment" parent-filter="byOrganization"
                                         domain-object-type="employee" title="Сотрудника">
                        <!-- название фильтра по тексту, введённому пользователем -->
                        <fill-parent-on-add field-to-fill="organization"/>
                        <input-text-filter name="byName"/>
                        <!-- паттерн отображения уже выбранных значений -->
                        <selection-pattern value="{name} {position}"/>

                    </node-collection-def>
                </node-collection-def>

                <!-- количество элементов, показываемых в данном узле дерева изначально -->
                <page-size>10</page-size>
                <single-choice value="false"/>
                <clear-all-button text="Очистить"/>
                <add-button image="..." text="Добавить"/>
                <display-values-as-links value="true"/>
                <linked-form name="city_form">
                    <title>
                        <existing-object>
                            <pattern value="{id}, {created_date}"/>
                            <formatting>
                                <date-format pattern="dd-mm-yyyy HH-mm-ss" style="short">
                                    <time-zone id="Europe/Kiev"/>
                                    <field-paths>
                                        <field-path value="created_date"/>
                                    </field-paths>
                                </date-format>
                            </formatting>
                        </existing-object>
                        <new-object>
                            <pattern value="new form "/>

                        </new-object>
                    </title>

                </linked-form>
            </hierarchy-browser>
            <label id="actual_start_period_label">
                <text>Актуально с:</text>
            </label>
            <label id="actual_end_period_label">
                <text>Актуально по:</text>
            </label>
            <date-box id="actual_start_period">
                <field-path value="actual_start_period"/>
                <range-end widget-id="actual_end_period"/>
            </date-box>
            <date-box id="actual_end_period">
                <field-path value="actual_end_period"/>
                <range-start widget-id="actual_start_period"/>
            </date-box>
        </widget-config>
    </form>

    <form name="employee_form" domain-object-type="Employee" is-default="true">
        <markup>
            <header>
                <table>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="Name-Label"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="Name"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                </table>
            </header>
            <body display-single-tab="false"> <!-- в теле - только закладки -->
                <tab name="Главная"> <!-- закладка состоит из групп с разметкой -->
                    <single-entry-group> <!-- наследник от TabGroupsConfig -->
                        <tab-group> <!-- вхождение в группу уже может содержать разметку -->
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="Department-Label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="Department"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td h-align="right">
                                        <widget id="positionLabel"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="position"/>
                                    </td>

                                    <td h-align="left">
                                        <widget id="hyperlink"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="label_empty_values"/>
                                    </td>

                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>
            </body>
        </markup>
        <widget-config>
            <label id="Name-Label">
                <field-path/>
                <relates-to widget-id="Name"/>
                <text>Название:</text>
            </label>
            <text-box id="Name">
                <field-path value="Name"/>
            </text-box>

            <label id="Department-Label">
                <relates-to widget-id="Department"/>
                <text>Департамент:</text>
            </label>
            <combo-box id="Department">
                <field-path value="Department"/>
                <pattern value="{Name}"/>
            </combo-box>

            <label id="positionLabel">
                <relates-to widget-id="position"/>
                <text>Должность:</text>
            </label>
            <text-box id="position">
                <field-path value="Position"/>
            </text-box>
            <linked-domain-object-hyperlink id="hyperlink"> <!-- для единичного связанного объекта -->
                <field-path value="department"/>
                <!-- для связанных объектов field-path обязательно должен ссылаться на поле типа reference -->
                <linked-form name="department_default_form">
                    <title>
                        <existing-object>
                            <pattern value="{id}, {created_date}"/>
                            <formatting>
                                <date-format pattern="dd-mm-yyyy HH-mm-ss" style="short">
                                    <time-zone id="Europe/Kiev"/>
                                    <field-paths>
                                        <field-path value="created_date"/>
                                    </field-paths>
                                </date-format>
                            </formatting>
                        </existing-object>
                        <new-object>
                            <pattern value="new form "/>

                        </new-object>
                    </title>
                </linked-form>
                <!-- форма, открывающаяся в модальном окне при нажатии на гиперссылку -->
                <pattern value="{name} {created_date}"/>
                <!-- в паттерне ссылки задаются относительно field-path -->
                <formatting>

                    <date-format pattern="dd-mm-yyyy HH:mm:ss" style="short">
                        <time-zone id="Europe/Kiev"/>
                        <field-paths>
                            <field-path value="created_date"/>
                        </field-paths>
                    </date-format>
                </formatting>
            </linked-domain-object-hyperlink>

            <label id="label_empty_values">
                <field-path value="phone, certificate"/>
                <font-weight value="bolder"/>
                <font-style value="italic"/>
                <font-size value="8px"/>
                <pattern value="{phone}, {certificate}"/>
                <all-values-empty-message value="Номер телефона: сертификат:"/>
            </label>
        </widget-config>
    </form>

    <form name="department_form" domain-object-type="Department" is-default="true">
        <markup>
            <header>
                <table>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="Name-Label"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="Name"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                </table>
            </header>
            <body display-single-tab="false"> <!-- в теле - только закладки -->
                <!--<tab name="Главная"> &lt;!&ndash; закладка состоит из групп с разметкой &ndash;&gt;
                    <single-entry-group> &lt;!&ndash; наследник от TabGroupsConfig &ndash;&gt;
                        <tab-group> &lt;!&ndash; вхождение в группу уже может содержать разметку &ndash;&gt;
                            <table>
                                <tr>
                                    <td h-align="right">
                                        <widget id="Organization-Label"/>
                                    </td>
                                    <td h-align="left">
                                        <widget id="Organization"/>
                                    </td>
                                </tr>
                            </table>
                        </tab-group>
                    </single-entry-group>
                </tab>-->
            </body>
        </markup>
        <widget-config>
            <label id="Name-Label">
                <field-path/>
                <relates-to widget-id="Name"/>
                <text>Название:</text>
            </label>
            <text-box id="Name">
                <field-path value="Name"/>
            </text-box>

            <label id="Organization-Label">
                <relates-to widget-id="Organization"/>
                <text>Организация:</text>
            </label>
            <combo-box id="Organization">
                <field-path value="Organization"/>
                <pattern value="{Name}"/>
            </combo-box>
        </widget-config>
    </form>

    <form name="organization_form" domain-object-type="Organization" is-default="true">
        <markup>
            <title>
                <new-object label-widget-id="titleNew"/>
                <existing-object label-widget-id="titleExisting"/>
            </title>
            <header>
                <table>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="Name-Label"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="Name"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="backRef"/>
                        </td>
                        <td width="100%" h-align="left">
                            <widget id="backRefLabel"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                    <tr>
                        <td width="100px" h-align="right">
                            <widget id="departmentsLabel"/>
                        </td>

                        <td width="100%" h-align="left">
                            <widget id="departmentsTableBro"/>
                        </td>
                        <!-- text-box (Название) -->
                    </tr>
                    <tr>
                        <td>
                            <widget id="cmfive1377"/>
                        </td>
                    </tr>
                </table>
            </header>
            <body display-single-tab="false">
            </body>
        </markup>
        <widget-config>
            <label id="Name-Label">
                <field-path/>
                <relates-to widget-id="Name"/>
                <text>Название:</text>
            </label>
            <text-box id="Name">
                <field-path value="Name"/>
            </text-box>
            <label id="backRefLabel">

                <text>BackRef</text>
            </label>
            <linked-domain-object-hyperlink id="backRef">
                <field-path value="org_middle^organization"/>
                <linked-form name="org_middle_form"/>
                <pattern value="{org_middle|organization.name}"/>
            </linked-domain-object-hyperlink>
            <label id="departmentsLabel">

                <text>Departments:</text>
            </label>
            <linked-domain-object-hyperlink id="hyperlink"> <!-- для единичного связанного объекта -->
                <field-path value="department^organization"/>
                <!-- для связанных объектов field-path обязательно должен ссылаться на поле типа reference -->
                <linked-form name="organization_default_form">
                </linked-form>
                <!-- форма, открывающаяся в модальном окне при нажатии на гиперссылку -->
                <pattern value="{name} {created_date}"/>
                <!-- в паттерне ссылки задаются относительно field-path -->
                <selection-filters row-limit="1"></selection-filters>
                <formatting>

                    <date-format pattern="dd-mm-yyyy HH:mm:ss" style="short">
                        <time-zone id="Europe/Kiev"/>
                        <field-paths>
                            <field-path value="created_date"/>
                        </field-paths>
                    </date-format>
                </formatting>
                <collection-ref name="Departments"/>

            </linked-domain-object-hyperlink>
            <date-box id="cmfive1377">
                <field-path value="created_date"/>
            </date-box>

            <table-browser id="departmentsTableBro" read-only="false">
                <field-path value="department^organization"/>
                <collection-ref name="Departments"/>

                <collection-view-ref name="departments_default_view"/>
                <selection-filters row-limit="100">

                </selection-filters>
                <!-- паттерн отображения уже выбранных значений -->
                <selection-pattern value="{name}"/>

                <input-text-filter name="byName"/>

                <!-- название фильтра по тексту, введённому пользователем -->
                <!--input-text-filter name="byNameforTableBrowser"/-->

                <!-- количество элементов, показываемых на одной странице выпадающего списка. в правом нижнем углу
                под таблицей указатель страниц (за пример нужно взять страницы поиска в Яндексе) -->
                <page-size>30</page-size>
                <display-chosen-values value="false"/>
                <selection-style name="inline"/>
                <single-choice value="false"/>
                <clear-all-button text="Очистить"/>
                <add-button image="..." text="Add"/>
                <!--default-sort-criteria column-field="created_date" order="desc" /-->
                <display-values-as-links value="true"/>
            </table-browser>
            <label id="titleExisting">
                <pattern value="date: {created_date}"/>
                <field-path value="created_date"/>
                <formatting>

                    <date-format pattern="dd.MM.yyyy HH:mm" style="short">

                        <field-paths>
                            <field-path value="created_date"/>
                        </field-paths>
                    </date-format>
                </formatting>
            </label>
            <label id="titleNew">
                <text>Coздание города</text>
            </label>
        </widget-config>
    </form>

    <form-mappings name="letter_mappings">
        <form-mapping domain-object-type="letter" form="letter_form">
            <field-path value="subject">
                <default-value>
                    <field value="Тема по умолчанию (из form-mapping)"/>
                </default-value>
            </field-path>
            <field-path value="actual_end_period">
                <default-value>
                    <field set-current-moment="true"/>
                </default-value>
            </field-path>
            <field-path value="letter_creator^letter.employee">
                <default-values>
                    <default-value>
                        <field>
                            <unique-key-value type="Employee">
                                <field name="Phone" value="8 (495) 777-55-01"/>
                            </unique-key-value>
                        </field>
                    </default-value>
                    <default-value>
                        <field>
                            <unique-key-value type="Employee">
                                <field name="Phone" value="8 (495) 777-55-04"/>
                            </unique-key-value>
                        </field>
                    </default-value>
                </default-values>
            </field-path>
            <users>
                <user uid="person2"/>
                <user uid="person7"/>
            </users>
            <groups>
                <group name="EmployeeBosses"/>
                <group name="test-group-2" priority="2"/>
            </groups>
        </form-mapping>
    </form-mappings>

    <collection-view name="org_middle_default_view" collection="org_middle_collection" is-default="true">
        <display>
            <column field="name" name="name" editable="false" type="string" sortable="true"/>

        </display>
    </collection-view>

    <collection-view name="letters_default_view" collection="Letters" is-default="true">
        <display>
            <column field="id" name="id" type="integer" sortable="false"/>
            <column field="subject" name="Тема" editable="false" type="string" sortable="true"/>
            <column field="created_date" name="Дата" editable="false" type="string" sortable="true"/>
            <column field="actual_start_period" name="Актуально с" editable="false" type="datetime" sortable="true"/>
            <column field="actual_end_period" name="Актуально по" editable="false" type="datetime" sortable="true"/>
        </display>
    </collection-view>
    <collection name="org_middle_collection" idField="id">
        <prototype>
            <![CDATA[
                    select
                        om.id, om.name, om.organization
                    from
                        org_middle om  where
                    1=1 ::where-clause
                ]]>
        </prototype>

        <counting-prototype>
            select count(*) from org_middle om
        </counting-prototype>
        <filter name="byText">
            <criteria placeholder="where-clause">
                <![CDATA[
                    om.name like {0}
                ]]>
            </criteria>
        </filter>
        <filter name="byId">
            <criteria placeholder="where-clause">
                <![CDATA[
                    om.organization = {0}
                ]]>
            </criteria>
        </filter>
    </collection>
    <collection name="employeesWithoutDepartment" idField="id">
        <prototype>
            <![CDATA[
                    select
                        em.id, em.name, em.position
                    from
                        employee em  where
                    em.organization IS NOT NULL ::where-clause
                ]]>
        </prototype>

        <counting-prototype>
            select count(*) from org_middle om
        </counting-prototype>
        <filter name="byText">
            <criteria placeholder="where-clause">
                <![CDATA[
                    em.name like {0}
                ]]>
            </criteria>
        </filter>
        <filter name="byOrganization">
            <criteria placeholder="where-clause">
                <![CDATA[
                    em.organization = {0}
                ]]>
            </criteria>
        </filter>
    </collection>
    <form-mappings name="org_middle_mappings">
        <form-mapping domain-object-type="org_middle" form="org_middle_form">
            <users>
                <user uid="admin"/>
            </users>
            <groups>
                <group name="Minister"/>
            </groups>
        </form-mapping>
    </form-mappings>
    <collection name="letters" idField="id">
        <prototype>
            <![CDATA[
                    select
                        l.id, l.subject, l.created_date, l.actual_start_period, l.actual_end_period
                    from
                        letter l
                ]]>
        </prototype>

        <counting-prototype>
            select count(*) from letter l
        </counting-prototype>
    </collection>

</configuration>